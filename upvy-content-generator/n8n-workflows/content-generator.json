{
  "id": "upvy-ai-content-generator",
  "name": "Upvy AI Content Generator",
  "nodes": [
    {
      "parameters": {},
      "id": "manual-trigger",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [-220, -200]
    },
    {
      "parameters": {
        "mode": "manual",
        "fields": {
          "values": [
            { "name": "language", "type": "stringValue", "stringValue": "en" }
          ]
        },
        "options": {}
      },
      "id": "set-manual-lang",
      "name": "Set Manual Language",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [0, -200]
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            { "triggerAtHour": 6 },
            { "triggerAtHour": 9 },
            { "triggerAtHour": 12 },
            { "triggerAtHour": 15 },
            { "triggerAtHour": 18 }
          ]
        }
      },
      "id": "trigger-en",
      "name": "Schedule EN (5/day)",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [0, 0]
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            { "triggerAtHour": 7 },
            { "triggerAtHour": 13 },
            { "triggerAtHour": 19 }
          ]
        }
      },
      "id": "trigger-ja",
      "name": "Schedule JA (3/day)",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [0, 200]
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            { "triggerAtHour": 8 },
            { "triggerAtHour": 14 },
            { "triggerAtHour": 20 }
          ]
        }
      },
      "id": "trigger-ko",
      "name": "Schedule KO (3/day)",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [0, 400]
    },
    {
      "parameters": {
        "mode": "manual",
        "fields": {
          "values": [
            { "name": "language", "type": "stringValue", "stringValue": "en" }
          ]
        },
        "options": {}
      },
      "id": "set-lang-en",
      "name": "Set Language EN",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [220, 0]
    },
    {
      "parameters": {
        "mode": "manual",
        "fields": {
          "values": [
            { "name": "language", "type": "stringValue", "stringValue": "ja" }
          ]
        },
        "options": {}
      },
      "id": "set-lang-ja",
      "name": "Set Language JA",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [220, 200]
    },
    {
      "parameters": {
        "mode": "manual",
        "fields": {
          "values": [
            { "name": "language", "type": "stringValue", "stringValue": "ko" }
          ]
        },
        "options": {}
      },
      "id": "set-lang-ko",
      "name": "Set Language KO",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [220, 400]
    },
    {
      "parameters": {
        "mode": "manual",
        "fields": {
          "values": [
            {
              "name": "category",
              "type": "stringValue",
              "stringValue": "={{ ['PROGRAMMING', 'SCIENCE', 'LANGUAGE', 'BUSINESS', 'PSYCHOLOGY', 'HEALTH'][Math.floor(Math.random() * 6)] }}"
            },
            {
              "name": "difficulty",
              "type": "stringValue",
              "stringValue": "={{ ['BEGINNER', 'INTERMEDIATE', 'ADVANCED'][Math.floor(Math.random() * 3)] }}"
            },
            {
              "name": "jobId",
              "type": "stringValue",
              "stringValue": "={{ $now.format('yyyyMMddHHmmss') }}-{{ Math.random().toString(36).substring(2, 8) }}"
            }
          ]
        },
        "options": {}
      },
      "id": "set-config",
      "name": "Set Config",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [440, 200]
    },
    {
      "parameters": {
        "jsCode": "const crypto = require('crypto');\nconst fs = require('fs');\n\nconst sa = JSON.parse(fs.readFileSync('/credentials/gcp-key.json', 'utf8'));\n\nconst header = Buffer.from(JSON.stringify({\n  alg: 'RS256',\n  typ: 'JWT'\n})).toString('base64url');\n\nconst now = Math.floor(Date.now() / 1000);\nconst claim = Buffer.from(JSON.stringify({\n  iss: sa.client_email,\n  scope: 'https://www.googleapis.com/auth/cloud-platform',\n  aud: 'https://oauth2.googleapis.com/token',\n  iat: now,\n  exp: now + 3600\n})).toString('base64url');\n\nconst sign = crypto.createSign('RSA-SHA256');\nsign.update(`${header}.${claim}`);\nconst signature = sign.sign(sa.private_key, 'base64url');\n\nconst jwt = `${header}.${claim}.${signature}`;\n\nreturn { json: { ...$input.first().json, gcpJwt: jwt } };"
      },
      "id": "gcp-jwt",
      "name": "Generate GCP JWT",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [660, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://oauth2.googleapis.com/token",
        "sendBody": true,
        "contentType": "form-urlencoded",
        "bodyParameters": {
          "parameters": [
            { "name": "grant_type", "value": "urn:ietf:params:oauth:grant-type:jwt-bearer" },
            { "name": "assertion", "value": "={{ $json.gcpJwt }}" }
          ]
        },
        "options": {}
      },
      "id": "gcp-token",
      "name": "Get GCP Access Token",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [880, 200]
    },
    {
      "parameters": {
        "jsCode": "const tokenResponse = $input.first().json;\nconst prevData = $('Generate GCP JWT').first().json;\nreturn { json: { ...prevData, gcpAccessToken: tokenResponse.access_token } };"
      },
      "id": "merge-token",
      "name": "Merge Token",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1100, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://{{ $env.VERTEX_AI_LOCATION }}-aiplatform.googleapis.com/v1/projects/{{ $env.GCP_PROJECT_ID }}/locations/{{ $env.VERTEX_AI_LOCATION }}/publishers/google/models/gemini-2.5-flash-lite:generateContent",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Authorization", "value": "=Bearer {{ $json.gcpAccessToken }}" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"contents\": [{\"role\": \"user\",\n    \"parts\": [{\n      \"text\": \"You are an educational content planner.\\n\\n[Task]\\n1. Search for trending educational topics in the \\\"{{ $json.category }}\\\" field\\n2. Suggest 3 topics suitable for short-form videos (30-60 seconds)\\n3. Evaluate viral potential and educational value for each\\n\\nDifficulty: {{ $json.difficulty }}\\n\\n**IMPORTANT: Generate ALL content (titles, hooks, key points) in {{ $json.language === 'ko' ? 'Korean' : ($json.language === 'ja' ? 'Japanese' : 'English') }} language.**\\n\\n[Output format - JSON only]\\n{\\n  \\\"topics\\\": [\\n    {\\n      \\\"title\\\": \\\"Topic title in target language\\\",\\n      \\\"hook\\\": \\\"Attention-grabbing first sentence in target language\\\",\\n      \\\"keyPoints\\\": [\\\"Point 1\\\", \\\"Point 2\\\", \\\"Point 3\\\"],\\n      \\\"viralScore\\\": 85,\\n      \\\"educationalScore\\\": 90\\n    }\\n  ]\\n}\"\n    }]\n  }],\n  \"tools\": [{ \"googleSearch\": {} }],\n  \"generationConfig\": {\n    \"temperature\": 0.7,\n    \"maxOutputTokens\": 2048\n  }\n}",
        "options": {
          "retry": {
            "maxTries": 3,
            "waitBetweenTries": 2000
          }
        }
      },
      "id": "topic-select",
      "name": "1. Topic Select (Gemini + Grounding)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1320, 200]
    },
    {
      "parameters": {
        "jsCode": "const response = $input.first().json;\nconst text = response.candidates?.[0]?.content?.parts?.[0]?.text;\n\nif (!text || text.trim() === '') {\n  const finishReason = response.candidates?.[0]?.finishReason;\n  const candidatesCount = response.candidates?.length || 0;\n  throw new Error(`Gemini returned empty response. finishReason: ${finishReason}, candidates: ${candidatesCount}. This may be a rate limit or grounding issue. Please retry.`);\n}\n\nlet jsonStr = text;\njsonStr = jsonStr.replace(/```json\\n?/g, '').replace(/```\\n?/g, '');\n\nconst firstBrace = jsonStr.indexOf('{');\nconst lastBrace = jsonStr.lastIndexOf('}');\nif (firstBrace !== -1 && lastBrace !== -1 && lastBrace > firstBrace) {\n  jsonStr = jsonStr.substring(firstBrace, lastBrace + 1);\n}\n\ntry {\n  const parsed = JSON.parse(jsonStr);\n  const topics = parsed.topics || [];\n  const bestTopic = topics.sort((a, b) => \n    (b.viralScore + b.educationalScore) - (a.viralScore + a.educationalScore)\n  )[0];\n  \n  if (!bestTopic) throw new Error('No topics in response. Raw: ' + text.substring(0, 300));\n  \n  return { json: { ...$input.first().json, selectedTopic: bestTopic, allTopics: topics } };\n} catch (e) {\n  throw new Error(`Topic parsing failed: ${e.message}\\nRaw: ${text.substring(0, 300)}`);\n}"
      },
      "id": "parse-topic",
      "name": "Parse Topic",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1540, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://{{ $env.VERTEX_AI_LOCATION }}-aiplatform.googleapis.com/v1/projects/{{ $env.GCP_PROJECT_ID }}/locations/{{ $env.VERTEX_AI_LOCATION }}/publishers/google/models/gemini-2.5-flash-lite:generateContent",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Authorization", "value": "=Bearer {{ $('Merge Token').first().json.gcpAccessToken }}" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"contents\": [{\"role\": \"user\",\n    \"parts\": [{\n      \"text\": \"You are an educational short-form content writer.\\nCreate a 60-second vertical (9:16) video script with quiz.\\n\\n=== Script Rules ===\\nCreate EXACTLY 5 sections with DIFFERENT visual scenes:\\n1. HOOK (0-5s): Attention-grabbing question or surprising fact\\n2. CORE_1 (5-20s): First key point with specific example\\n3. CORE_2 (20-35s): Second key point with demonstration\\n4. CORE_3 (35-50s): Third key point with real-world application\\n5. CTA (50-60s): Call to action and summary\\n\\nFormat rules:\\n- Each sentence under 15 words\\n- Explain technical terms immediately\\n- Friendly, conversational tone\\n\\n=== Visual Cue Rules (CRITICAL) ===\\nEach section MUST have a COMPLETELY DIFFERENT visualCue:\\n- HOOK: Attention-grabbing scene related to the problem\\n- CORE_1: Visual showing the first concept/example\\n- CORE_2: Different visual demonstrating the second point\\n- CORE_3: Another unique visual for practical application\\n- CTA: Motivational/action-oriented scene\\n\\nEach visualCue must describe:\\n- A realistic, photographic scene (NOT cartoon/illustration)\\n- Specific objects, settings, people, or demonstrations\\n- Professional educational style like documentary\\n- MUST be visually distinct from other sections\\n\\n=== Quiz Rules ===\\n1. One question testing the core concept\\n2. 4 options (1 correct + 3 incorrect)\\n\\n[Topic Info]\\nTitle: {{ $json.selectedTopic.title }}\\nHook: {{ $json.selectedTopic.hook }}\\nKey Points: {{ $json.selectedTopic.keyPoints.join(', ') }}\\nDifficulty: {{ $json.difficulty }}\\n\\n**CRITICAL: Write ALL narration, title, description, quiz in {{ $json.language === 'ko' ? 'Korean (한국어)' : ($json.language === 'ja' ? 'Japanese (日本語)' : 'English') }}.**\\n\\n[Output format - JSON only]\\n{\\n  \\\"script\\\": {\\n    \\\"title\\\": \\\"Video title\\\",\\n    \\\"description\\\": \\\"Video description (200 chars)\\\",\\n    \\\"totalDuration\\\": 60,\\n    \\\"sections\\\": [\\n      {\\n        \\\"type\\\": \\\"HOOK\\\",\\n        \\\"startTime\\\": 0,\\n        \\\"endTime\\\": 5,\\n        \\\"narration\\\": \\\"Hook narration\\\",\\n        \\\"visualCue\\\": \\\"Realistic photo: Close-up of frustrated student staring at complex equations on paper, dim desk lamp lighting\\\"\\n      },\\n      {\\n        \\\"type\\\": \\\"CORE_1\\\",\\n        \\\"startTime\\\": 5,\\n        \\\"endTime\\\": 20,\\n        \\\"narration\\\": \\\"First key point narration\\\",\\n        \\\"visualCue\\\": \\\"Professional photo: Teacher writing on whiteboard with colorful diagrams, bright classroom\\\"\\n      },\\n      {\\n        \\\"type\\\": \\\"CORE_2\\\",\\n        \\\"startTime\\\": 20,\\n        \\\"endTime\\\": 35,\\n        \\\"narration\\\": \\\"Second key point narration\\\",\\n        \\\"visualCue\\\": \\\"Documentary style: Hands-on demonstration with physical objects on table, natural lighting\\\"\\n      },\\n      {\\n        \\\"type\\\": \\\"CORE_3\\\",\\n        \\\"startTime\\\": 35,\\n        \\\"endTime\\\": 50,\\n        \\\"narration\\\": \\\"Third key point narration\\\",\\n        \\\"visualCue\\\": \\\"Real-world application: Person using concept in daily life or work setting\\\"\\n      },\\n      {\\n        \\\"type\\\": \\\"CTA\\\",\\n        \\\"startTime\\\": 50,\\n        \\\"endTime\\\": 60,\\n        \\\"narration\\\": \\\"Call to action narration\\\",\\n        \\\"visualCue\\\": \\\"Motivational: Confident person with achievement gesture, warm inspiring lighting\\\"\\n      }\\n    ],\\n    \\\"tags\\\": [\\\"tag1\\\", \\\"tag2\\\"]\\n  },\\n  \\\"quiz\\\": {\\n    \\\"question\\\": \\\"Quiz question\\\",\\n    \\\"options\\\": [\\n      {\\\"text\\\": \\\"Option 1\\\", \\\"isCorrect\\\": true},\\n      {\\\"text\\\": \\\"Option 2\\\", \\\"isCorrect\\\": false},\\n      {\\\"text\\\": \\\"Option 3\\\", \\\"isCorrect\\\": false},\\n      {\\\"text\\\": \\\"Option 4\\\", \\\"isCorrect\\\": false}\\n    ]\\n  },\\n  \\\"qualityCheck\\\": {\\n    \\\"verdict\\\": \\\"PASS\\\",\\n    \\\"reason\\\": \\\"Quality review reason\\\"\\n  }\\n}\"\n    }]\n  }],\n  \"generationConfig\": {\n    \"temperature\": 0.8,\n    \"maxOutputTokens\": 4096\n  }\n}",
        "options": {}
      },
      "id": "script-quiz-gen",
      "name": "2. Script + Quiz Gen (Gemini)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1760, 200]
    },
    {
      "parameters": {
        "jsCode": "const response = $input.first().json;\nconst text = response.candidates?.[0]?.content?.parts?.[0]?.text || '{}';\n\nlet jsonStr = text;\njsonStr = jsonStr.replace(/```json\\n?/g, '').replace(/```\\n?/g, '');\n\nconst firstBrace = jsonStr.indexOf('{');\nconst lastBrace = jsonStr.lastIndexOf('}');\nif (firstBrace !== -1 && lastBrace !== -1 && lastBrace > firstBrace) {\n  jsonStr = jsonStr.substring(firstBrace, lastBrace + 1);\n}\n\ntry {\n  const parsed = JSON.parse(jsonStr);\n  if (!parsed.script || !parsed.quiz || !parsed.qualityCheck) throw new Error('Missing required fields');\n  \n  return {\n    json: {\n      ...$input.first().json,\n      script: parsed.script,\n      quiz: parsed.quiz,\n      qualityCheck: parsed.qualityCheck,\n      totalDuration: parsed.script.totalDuration || 60\n    }\n  };\n} catch (e) {\n  throw new Error(`Script parsing failed: ${e.message}\\nRaw: ${text.substring(0, 200)}...`);\n}"
      },
      "id": "parse-script",
      "name": "Parse Script + Quiz",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1980, 200]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "quality-check",
              "leftValue": "={{ $json.qualityCheck.verdict }}",
              "rightValue": "PASS",
              "operator": { "type": "string", "operation": "equals" }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "quality-gate",
      "name": "3. Quality Gate",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [2200, 200]
    },
    {
      "parameters": {
        "jsCode": "const prevContext = $input.first().json;\nconst sections = prevContext.script.sections || [];\n\n// 5개 섹션에 대한 이미지 요청 준비 (HOOK, CORE_1, CORE_2, CORE_3, CTA)\nconst items = sections.map((section, index) => {\n  const visualCue = section.visualCue || `Educational image about ${prevContext.category}`;\n  const prompt = `Professional educational photograph: ${visualCue}. ` +\n    `High-quality, photorealistic style. ` +\n    `Clean composition, professional lighting. ` +\n    `Suitable for educational video content. ` +\n    `Vertical 9:16 format. ` +\n    `NO cartoon, NO illustration, NO anime style. ` +\n    `NO text, NO watermarks. ` +\n    `Realistic and professional appearance.`;\n  \n  return {\n    json: {\n      sectionIndex: index,\n      sectionType: section.type,\n      startTime: section.startTime,\n      endTime: section.endTime,\n      duration: section.endTime - section.startTime,\n      imagePrompt: prompt,\n      // 원본 컨텍스트도 포함 (Merge용)\n      _context: prevContext\n    }\n  };\n});\n\nreturn items;"
      },
      "id": "prepare-image-requests",
      "name": "4a-1. Prepare Image Requests",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2420, 100]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://{{ $env.VERTEX_AI_LOCATION }}-aiplatform.googleapis.com/v1/projects/{{ $env.GCP_PROJECT_ID }}/locations/{{ $env.VERTEX_AI_LOCATION }}/publishers/google/models/imagen-3.0-generate-002:predict",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Authorization", "value": "=Bearer {{ $('Merge Token').first().json.gcpAccessToken }}" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ instances: [{ prompt: $json.imagePrompt }], parameters: { sampleCount: 1, aspectRatio: '9:16', safetyFilterLevel: 'block_only_high', personGeneration: 'allow_adult' } }) }}",
        "options": {
          "batching": {
            "batch": {
              "batchSize": 1,
              "batchInterval": 10000
            }
          },
          "retry": {
            "maxTries": 5,
            "waitBetweenTries": 10000
          }
        }
      },
      "id": "visual-gen-http",
      "name": "4a-2. Generate Image",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2640, 0]
    },
    {
      "parameters": {},
      "id": "clone-data",
      "name": "4a-2b. Clone Data",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [2640, 200]
    },
    {
      "parameters": {
        "mode": "append"
      },
      "id": "merge-response-original",
      "name": "4a-3. Merge Response+Original",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2,
      "position": [2860, 100]
    },
    {
      "parameters": {
        "jsCode": "// 실패한 이미지만 재시도하는 로직 포함\nconst allItems = $input.all();\n\nconst httpResponses = allItems.filter(item => item.json.predictions !== undefined || (Object.keys(item.json).length === 0));\nconst originalDataItems = allItems.filter(item => \n  item.json.imagePrompt && item.json.sectionIndex !== undefined && !item.json.predictions\n);\n\nif (originalDataItems.length !== 5) {\n  throw new Error(`Expected 5 original items, got ${originalDataItems.length}`);\n}\n\noriginalDataItems.sort((a, b) => a.json.sectionIndex - b.json.sectionIndex);\n\n// GCP 토큰 가져오기\nconst gcpToken = $('Merge Token').first().json.gcpAccessToken;\nconst projectId = $env.GCP_PROJECT_ID;\nconst location = $env.VERTEX_AI_LOCATION;\nconst apiUrl = `https://${location}-aiplatform.googleapis.com/v1/projects/${projectId}/locations/${location}/publishers/google/models/imagen-3.0-generate-002:predict`;\n\nconst errors = [];\n\n// 재시도 함수 (this.helpers.httpRequest 사용)\nasync function generateWithRetry(prompt, sectionType, maxRetries = 5, delay = 10000) {\n  for (let attempt = 1; attempt <= maxRetries; attempt++) {\n    try {\n      const data = await this.helpers.httpRequest({\n        method: 'POST',\n        url: apiUrl,\n        headers: {\n          'Authorization': `Bearer ${gcpToken}`,\n          'Content-Type': 'application/json'\n        },\n        body: {\n          instances: [{ prompt }],\n          parameters: { sampleCount: 1, aspectRatio: '9:16', safetyFilterLevel: 'block_only_high', personGeneration: 'allow_adult' }\n        },\n        json: true\n      });\n      if (data?.predictions?.[0]?.bytesBase64Encoded) {\n        return data.predictions[0].bytesBase64Encoded;\n      }\n      errors.push(`${sectionType} attempt ${attempt}: empty response - ${JSON.stringify(data).substring(0, 200)}`);\n    } catch (e) {\n      errors.push(`${sectionType} attempt ${attempt}: ${e.message}`);\n    }\n    if (attempt < maxRetries) {\n      await new Promise(r => setTimeout(r, delay));\n    }\n  }\n  return null;\n}\n\nconst results = [];\nfor (let i = 0; i < 5; i++) {\n  const original = originalDataItems[i];\n  const httpItem = httpResponses[i];\n  let imageBase64 = httpItem?.json?.predictions?.[0]?.bytesBase64Encoded;\n  \n  // 실패한 경우 재시도\n  if (!imageBase64) {\n    imageBase64 = await generateWithRetry.call(this, original.json.imagePrompt, original.json.sectionType);\n  }\n  \n  if (!imageBase64) {\n    throw new Error(`Image gen failed for ${original.json.sectionType}(${i}) after retries. Errors: ${errors.join(' | ')}`);\n  }\n  \n  results.push({\n    json: {\n      sectionIndex: original.json.sectionIndex,\n      sectionType: original.json.sectionType,\n      startTime: original.json.startTime,\n      endTime: original.json.endTime,\n      duration: original.json.duration,\n      imageBase64: imageBase64,\n      _context: original.json._context || {}\n    }\n  });\n}\n\nreturn results;"
      },
      "id": "combine-image-data",
      "name": "4a-4. Combine Image Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [3080, 100]
    },
    {
      "parameters": {
        "jsCode": "// 모든 이미지 수집 및 정렬\nconst items = $input.all();\n\nconst generatedImages = items.map(item => {\n  const json = item.json;\n  return {\n    sectionIndex: json.sectionIndex,\n    sectionType: json.sectionType,\n    startTime: json.startTime,\n    endTime: json.endTime,\n    duration: json.duration,\n    imageBase64: json.imageBase64\n  };\n});\n\n// sectionIndex로 정렬\ngeneratedImages.sort((a, b) => a.sectionIndex - b.sectionIndex);\n\n// 첫 번째 아이템에서 원본 컨텍스트 가져오기\nconst context = items[0]?.json?._context || {};\n\nif (generatedImages.length === 0) {\n  throw new Error('No images were generated.');\n}\n\nif (generatedImages.length !== 5) {\n  throw new Error(`Expected 5 images but got ${generatedImages.length}`);\n}\n\nreturn {\n  json: {\n    ...context,\n    generatedImages: generatedImages\n  }\n};"
      },
      "id": "aggregate-images",
      "name": "4a-5. Aggregate Images",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [3300, 100]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://texttospeech.googleapis.com/v1/text:synthesize",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Authorization", "value": "=Bearer {{ $('Merge Token').first().json.gcpAccessToken }}" },
            { "name": "x-goog-user-project", "value": "={{ $env.GCP_PROJECT_ID }}" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"input\": {\n    \"text\": \"{{ $json.script.sections.map(s => s.narration).join(' ') }}\"\n  },\n  \"voice\": {\n    \"languageCode\": \"{{ $json.language === 'en' ? 'en-US' : ($json.language === 'ja' ? 'ja-JP' : 'ko-KR') }}\",\n    \"name\": \"{{ $json.language === 'en' ? 'Aoede' : ($json.language === 'ja' ? 'Zephyr' : 'Kore') }}\",\n    \"modelName\": \"gemini-2.5-flash-tts\"\n  },\n  \"audioConfig\": {\n    \"audioEncoding\": \"MP3\",\n    \"sampleRateHertz\": 24000\n  }\n}",
        "options": {}
      },
      "id": "tts-gen",
      "name": "4b. TTS (Gemini TTS)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2420, 400]
    },
    {
      "parameters": {
        "jsCode": "const prevContext = $('4a-5. Aggregate Images').first().json;\nconst generatedImages = prevContext.generatedImages || [];\n\n// 5개 이미지를 바이너리로 변환\nconst binaries = {};\nfor (let i = 0; i < generatedImages.length; i++) {\n  const img = generatedImages[i];\n  binaries[`image_${i}`] = {\n    data: img.imageBase64,\n    mimeType: 'image/png',\n    fileName: `section_${i}.png`\n  };\n}\n\nreturn {\n  json: prevContext,\n  binary: binaries\n};"
      },
      "id": "convert-visual",
      "name": "Convert Visuals to Binary",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [3520, 100]
    },
    {
      "parameters": {
        "jsCode": "const item = $input.first();\nconst prevContext = $('3. Quality Gate').first().json;\nconst audioBase64 = item.json.audioContent;\n\nif (!audioBase64) throw new Error('TTS response missing audioContent: ' + JSON.stringify(item.json).substring(0, 500));\n\nreturn {\n  json: { ...prevContext },\n  binary: {\n    audio: {\n      data: audioBase64,\n      mimeType: 'audio/mp3',\n      fileName: 'narration.mp3'\n    }\n  }\n};"
      },
      "id": "prepare-audio",
      "name": "Prepare Audio Binary",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [3520, 400]
    },
    {
      "parameters": {
        "mode": "append"
      },
      "id": "merge-visual-audio",
      "name": "Merge Visual + Audio",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2,
      "position": [3740, 200]
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst visualItem = items.find(i => i.binary?.image_0);\nconst audioItem = items.find(i => i.binary?.audio);\n\nconst jsonData = visualItem?.json || audioItem?.json || {};\n\nlet combinedBinary = {};\nfor (const item of items) {\n  if (item.binary) {\n    combinedBinary = { ...combinedBinary, ...item.binary };\n  }\n}\n\nreturn { json: jsonData, binary: combinedBinary };"
      },
      "id": "combine-binaries",
      "name": "Combine Binaries",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [3960, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://compose-service:8084/api/v1/compose",
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            { "parameterType": "formBinaryData", "name": "clips", "inputDataFieldName": "image_0" },
            { "parameterType": "formBinaryData", "name": "clips", "inputDataFieldName": "image_1" },
            { "parameterType": "formBinaryData", "name": "clips", "inputDataFieldName": "image_2" },
            { "parameterType": "formBinaryData", "name": "clips", "inputDataFieldName": "image_3" },
            { "parameterType": "formBinaryData", "name": "clips", "inputDataFieldName": "image_4" },
            { "parameterType": "formBinaryData", "name": "audio", "inputDataFieldName": "audio" },
            {
              "parameterType": "formData",
              "name": "metadata",
              "value": "={{ JSON.stringify({ title: $json.script.title, watermark: true, language: $json.language, clipDurations: $json.generatedImages.map(img => img.duration), subtitles: $json.script.sections.map(s => ({ start: s.startTime, end: s.endTime, text: s.narration })) }) }}"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "id": "compose",
      "name": "5. Compose (FFmpeg)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [4180, 200]
    },
    {
      "parameters": {
        "jsCode": "const item = $input.first();\nconst videoBinary = item.binary?.data;\n\nif (!videoBinary) throw new Error('No video response from compose service');\n\nconst prevContext = $('Combine Binaries').first().json;\n\n// 첫 번째 이미지를 썸네일로 사용\nconst firstImage = prevContext.generatedImages && prevContext.generatedImages[0];\nconst thumbnailBase64 = firstImage ? firstImage.imageBase64 : null;\n\nconst result = {\n  json: { ...prevContext, composedAt: new Date().toISOString() },\n  binary: {\n    video: { \n      data: videoBinary.data, \n      mimeType: 'video/mp4', \n      fileName: 'final.mp4' \n    }\n  }\n};\n\nif (thumbnailBase64) {\n  result.binary.thumbnail = {\n    data: thumbnailBase64,\n    mimeType: 'image/png',\n    fileName: 'thumbnail.png'\n  };\n}\n\nreturn result;"
      },
      "id": "process-video",
      "name": "Process Video Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [4400, 200]
    },
    {
      "parameters": {
        "operation": "upload",
        "bucketName": "={{ $env.S3_BUCKET }}",
        "fileName": "=generated/{{ $json.jobId }}/final.mp4",
        "binaryPropertyName": "video"
      },
      "id": "s3-upload-video",
      "name": "S3 Upload Video",
      "type": "n8n-nodes-base.awsS3",
      "typeVersion": 1,
      "position": [4620, 100]
    },
    {
      "parameters": {
        "operation": "upload",
        "bucketName": "={{ $env.S3_BUCKET }}",
        "fileName": "=generated/{{ $json.jobId }}/thumbnail.jpg",
        "binaryPropertyName": "thumbnail"
      },
      "id": "s3-upload-thumbnail",
      "name": "S3 Upload Thumbnail",
      "type": "n8n-nodes-base.awsS3",
      "typeVersion": 1,
      "position": [4620, 300]
    },
    {
      "parameters": {
        "mode": "append"
      },
      "id": "merge-s3-results",
      "name": "Merge S3 Results",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2,
      "position": [4840, 200]
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst prevContext = $('Process Video Response').first().json;\n\nconst s3Region = $env.AWS_REGION || 'ap-northeast-2';\nconst s3Bucket = $env.S3_BUCKET;\n\nconst videoUrl = `https://${s3Bucket}.s3.${s3Region}.amazonaws.com/generated/${prevContext.jobId}/final.mp4`;\nconst thumbnailUrl = `https://${s3Bucket}.s3.${s3Region}.amazonaws.com/generated/${prevContext.jobId}/thumbnail.jpg`;\n\nreturn {\n  json: {\n    ...prevContext,\n    videoUrl,\n    thumbnailUrl,\n    s3Key: `generated/${prevContext.jobId}/final.mp4`,\n    thumbnailS3Key: `generated/${prevContext.jobId}/thumbnail.jpg`\n  }\n};"
      },
      "id": "set-s3-urls",
      "name": "Set S3 URLs",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [5060, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.UPVY_API_URL }}/api/v1/contents",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"title\": \"{{ $json.script.title }}\",\n  \"description\": \"{{ $json.script.description }}\",\n  \"category\": \"{{ $json.category }}\",\n  \"tags\": {{ JSON.stringify($json.script.tags) }},\n  \"language\": \"{{ $json.language }}\",\n  \"videoUrl\": \"{{ $json.videoUrl }}\",\n  \"thumbnailUrl\": \"{{ $json.thumbnailUrl }}\",\n  \"duration\": {{ $json.totalDuration || 60 }},\n  \"width\": 1080,\n  \"height\": 1920,\n  \"quiz\": {{ JSON.stringify($json.quiz) }}\n}",
        "options": {}
      },
      "id": "upvy-publish",
      "name": "6a. Upvy Publish",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [5280, 100]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://www.googleapis.com/upload/youtube/v3/videos?uploadType=resumable&part=snippet,status",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"snippet\": {\n    \"title\": \"{{ $json.script.title }}\",\n    \"description\": \"{{ $json.script.description }}\\n\\n#Shorts\",\n    \"tags\": {{ JSON.stringify([...$json.script.tags, 'Shorts']) }},\n    \"categoryId\": \"27\",\n    \"defaultLanguage\": \"{{ $json.language }}\"\n  },\n  \"status\": {\n    \"privacyStatus\": \"public\",\n    \"selfDeclaredMadeForKids\": false\n  }\n}",
        "options": {}
      },
      "id": "youtube-publish",
      "name": "6b. YouTube Shorts",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [5280, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v18.0/{{ $env.INSTAGRAM_USER_ID }}/media",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"media_type\": \"REELS\",\n  \"video_url\": \"{{ $json.videoUrl }}\",\n  \"caption\": \"{{ $json.script.title }}\\n\\n{{ $json.script.description }}\\n\\n#{{ $json.script.tags.join(' #') }}\"\n}",
        "options": {}
      },
      "id": "instagram-publish",
      "name": "6c. Instagram Reels",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [5280, 500]
    },
    {
      "parameters": {
        "chatId": "={{ $env.TELEGRAM_CHAT_ID }}",
        "text": "=✅ *AI Content Generated*\n\n*Job ID:* {{ $json.jobId }}\n*Title:* {{ $json.script.title }}\n*Language:* {{ $json.language }}\n*Category:* {{ $json.category }}\n*Sections:* {{ $json.generatedImages?.length || 0 }} images\n\n*S3:*\n• Video: {{ $json.videoUrl }}\n• Thumbnail: {{ $json.thumbnailUrl }}",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "id": "telegram-success",
      "name": "Telegram - Success",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [5500, 200],
      "credentials": {
        "telegramApi": {
          "name": "Telegram API"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $env.TELEGRAM_CHAT_ID }}",
        "text": "=❌ *AI Content Skipped*\n\n*Job ID:* {{ $json.jobId }}\n*Reason:* Quality check failed\n\n*Quality Review:*\n{{ $json.qualityCheck?.reason || 'N/A' }}",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "id": "telegram-failure",
      "name": "Telegram - Quality Fail",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [2420, 500],
      "credentials": {
        "telegramApi": {
          "name": "Telegram API"
        }
      }
    }
  ],
  "connections": {
    "Manual Trigger": {
      "main": [[{ "node": "Set Manual Language", "type": "main", "index": 0 }]]
    },
    "Set Manual Language": {
      "main": [[{ "node": "Set Config", "type": "main", "index": 0 }]]
    },
    "Schedule EN (5/day)": {
      "main": [[{ "node": "Set Language EN", "type": "main", "index": 0 }]]
    },
    "Schedule JA (3/day)": {
      "main": [[{ "node": "Set Language JA", "type": "main", "index": 0 }]]
    },
    "Schedule KO (3/day)": {
      "main": [[{ "node": "Set Language KO", "type": "main", "index": 0 }]]
    },
    "Set Language EN": {
      "main": [[{ "node": "Set Config", "type": "main", "index": 0 }]]
    },
    "Set Language JA": {
      "main": [[{ "node": "Set Config", "type": "main", "index": 0 }]]
    },
    "Set Language KO": {
      "main": [[{ "node": "Set Config", "type": "main", "index": 0 }]]
    },
    "Set Config": {
      "main": [[{ "node": "Generate GCP JWT", "type": "main", "index": 0 }]]
    },
    "Generate GCP JWT": {
      "main": [[{ "node": "Get GCP Access Token", "type": "main", "index": 0 }]]
    },
    "Get GCP Access Token": {
      "main": [[{ "node": "Merge Token", "type": "main", "index": 0 }]]
    },
    "Merge Token": {
      "main": [[{ "node": "1. Topic Select (Gemini + Grounding)", "type": "main", "index": 0 }]]
    },
    "1. Topic Select (Gemini + Grounding)": {
      "main": [[{ "node": "Parse Topic", "type": "main", "index": 0 }]]
    },
    "Parse Topic": {
      "main": [[{ "node": "2. Script + Quiz Gen (Gemini)", "type": "main", "index": 0 }]]
    },
    "2. Script + Quiz Gen (Gemini)": {
      "main": [[{ "node": "Parse Script + Quiz", "type": "main", "index": 0 }]]
    },
    "Parse Script + Quiz": {
      "main": [[{ "node": "3. Quality Gate", "type": "main", "index": 0 }]]
    },
    "3. Quality Gate": {
      "main": [
        [
          { "node": "4a-1. Prepare Image Requests", "type": "main", "index": 0 },
          { "node": "4b. TTS (Gemini TTS)", "type": "main", "index": 0 }
        ],
        [{ "node": "Telegram - Quality Fail", "type": "main", "index": 0 }]
      ]
    },
    "4a-1. Prepare Image Requests": {
      "main": [
        [
          { "node": "4a-2. Generate Image", "type": "main", "index": 0 },
          { "node": "4a-2b. Clone Data", "type": "main", "index": 0 }
        ]
      ]
    },
    "4a-2. Generate Image": {
      "main": [[{ "node": "4a-3. Merge Response+Original", "type": "main", "index": 0 }]]
    },
    "4a-2b. Clone Data": {
      "main": [[{ "node": "4a-3. Merge Response+Original", "type": "main", "index": 1 }]]
    },
    "4a-3. Merge Response+Original": {
      "main": [[{ "node": "4a-4. Combine Image Data", "type": "main", "index": 0 }]]
    },
    "4a-4. Combine Image Data": {
      "main": [[{ "node": "4a-5. Aggregate Images", "type": "main", "index": 0 }]]
    },
    "4a-5. Aggregate Images": {
      "main": [[{ "node": "Convert Visuals to Binary", "type": "main", "index": 0 }]]
    },
    "4b. TTS (Gemini TTS)": {
      "main": [[{ "node": "Prepare Audio Binary", "type": "main", "index": 0 }]]
    },
    "Convert Visuals to Binary": {
      "main": [[{ "node": "Merge Visual + Audio", "type": "main", "index": 0 }]]
    },
    "Prepare Audio Binary": {
      "main": [[{ "node": "Merge Visual + Audio", "type": "main", "index": 1 }]]
    },
    "Merge Visual + Audio": {
      "main": [[{ "node": "Combine Binaries", "type": "main", "index": 0 }]]
    },
    "Combine Binaries": {
      "main": [[{ "node": "5. Compose (FFmpeg)", "type": "main", "index": 0 }]]
    },
    "5. Compose (FFmpeg)": {
      "main": [[{ "node": "Process Video Response", "type": "main", "index": 0 }]]
    },
    "Process Video Response": {
      "main": [
        [
          { "node": "S3 Upload Video", "type": "main", "index": 0 },
          { "node": "S3 Upload Thumbnail", "type": "main", "index": 0 }
        ]
      ]
    },
    "S3 Upload Video": {
      "main": [[{ "node": "Merge S3 Results", "type": "main", "index": 0 }]]
    },
    "S3 Upload Thumbnail": {
      "main": [[{ "node": "Merge S3 Results", "type": "main", "index": 1 }]]
    },
    "Merge S3 Results": {
      "main": [[{ "node": "Set S3 URLs", "type": "main", "index": 0 }]]
    },
    "Set S3 URLs": {
      "main": [
        [
          { "node": "6a. Upvy Publish", "type": "main", "index": 0 },
          { "node": "6b. YouTube Shorts", "type": "main", "index": 0 },
          { "node": "6c. Instagram Reels", "type": "main", "index": 0 }
        ]
      ]
    },
    "6a. Upvy Publish": {
      "main": [[{ "node": "Telegram - Success", "type": "main", "index": 0 }]]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "saveDataSuccessExecution": "all",
    "saveDataErrorExecution": "all",
    "timezone": "Asia/Seoul"
  },
  "staticData": null,
  "tags": [{ "name": "ai-content" }],
  "triggerCount": 4
}

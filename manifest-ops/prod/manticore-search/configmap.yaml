apiVersion: v1
kind: ConfigMap
metadata:
  name: upvy-manticore-search-config
  labels:
    app: upvy-manticore-search
data:
  manticore.conf: |
    searchd {
        listen = 9306:mysql41
        listen = 9308:http
        pid_file = /var/run/manticore/searchd.pid
        log = /var/log/manticore/searchd.log
        query_log = /var/log/manticore/query.log
        binlog_path = /var/lib/manticore
    }

    # ============================================
    # Content Search Index
    # ============================================
    source content_src
    {
        type            = mysql
        sql_host        = ${MYSQL_HOST}
        sql_user        = ${DB_USERNAME}
        sql_pass        = ${DB_PASSWORD}
        sql_db          = ${MYSQL_DATABASE}
        sql_port        = ${MYSQL_PORT}
        sql_query       = \
            SELECT \
                cm.id AS id, \
                c.id AS content_id, \
                cm.title, \
                cm.description, \
                COALESCE(GROUP_CONCAT(t.name SEPARATOR ' '), '') AS tags, \
                cm.category, \
                cm.language, \
                c.creator_id, \
                c.thumbnail_url, \
                c.content_type, \
                c.status, \
                UNIX_TIMESTAMP(c.created_at) AS created_at \
            FROM content_metadata cm \
            INNER JOIN contents c ON cm.content_id = c.id \
            LEFT JOIN content_tags ct ON c.id = ct.content_id AND ct.deleted_at IS NULL \
            LEFT JOIN tags t ON ct.tag_id = t.id AND t.deleted_at IS NULL \
            WHERE c.deleted_at IS NULL \
              AND cm.deleted_at IS NULL \
              AND c.status = 'PUBLISHED' \
            GROUP BY cm.id, c.id, cm.title, cm.description, cm.category, cm.language, \
                     c.creator_id, c.thumbnail_url, c.content_type, c.status, c.created_at

        sql_attr_string   = content_id
        sql_attr_string   = category
        sql_attr_string   = language
        sql_attr_string   = creator_id
        sql_attr_string   = thumbnail_url
        sql_attr_string   = content_type
        sql_attr_string   = status
        sql_attr_timestamp = created_at
    }

    index content_index {
        type = plain
        source          = content_src
        path            = /var/lib/manticore/content_index

        docinfo         = extern
        mlock           = 0
        charset_table   = 0..9, A..Z->a..z, a..z
        min_word_len    = 1
        min_infix_len   = 1
        infix_fields    = title, description, tags
        ngram_len       = 2
        ngram_chars     = U+AC00..U+D7AF, U+1100..U+11FF, U+3130..U+318F, U+3040..U+309F, U+30A0..U+30FF, U+4E00..U+9FFF
    }

    # ============================================
    # User Search Index
    # ============================================
    source user_src
    {
        type            = mysql
        sql_host        = ${MYSQL_HOST}
        sql_user        = ${DB_USERNAME}
        sql_pass        = ${DB_PASSWORD}
        sql_db          = ${MYSQL_DATABASE}
        sql_port        = ${MYSQL_PORT}
        sql_query       = \
            SELECT \
                up.id AS id, \
                u.id AS user_id, \
                up.nickname, \
                up.bio, \
                up.profile_image_url, \
                up.follower_count, \
                up.following_count, \
                UNIX_TIMESTAMP(up.created_at) AS created_at \
            FROM user_profiles up \
            INNER JOIN users u ON up.user_id = u.id \
            WHERE u.deleted_at IS NULL \
              AND up.deleted_at IS NULL \
              AND u.status = 'ACTIVE'

        sql_attr_string   = user_id
        sql_attr_string   = profile_image_url
        sql_attr_uint     = follower_count
        sql_attr_uint     = following_count
        sql_attr_timestamp = created_at
    }

    index user_index {
        type = plain
        source          = user_src
        path            = /var/lib/manticore/user_index

        docinfo         = extern
        mlock           = 0
        charset_table   = 0..9, A..Z->a..z, a..z
        min_word_len    = 1
        min_infix_len   = 1
        infix_fields    = nickname, bio
        ngram_len       = 2
        ngram_chars     = U+AC00..U+D7AF, U+1100..U+11FF, U+3130..U+318F, U+3040..U+309F, U+30A0..U+30FF, U+4E00..U+9FFF
    }

    # ============================================
    # Tag Search Index (태그 자동완성 및 검색)
    # ============================================
    source tag_src
    {
        type            = mysql
        sql_host        = ${MYSQL_HOST}
        sql_user        = ${DB_USERNAME}
        sql_pass        = ${DB_PASSWORD}
        sql_db          = ${MYSQL_DATABASE}
        sql_port        = ${MYSQL_PORT}
        sql_query       = \
            SELECT \
                id, \
                name AS text, \
                usage_count, \
                UNIX_TIMESTAMP(created_at) AS created_at \
            FROM tags \
            WHERE deleted_at IS NULL

        sql_attr_uint     = usage_count
        sql_attr_timestamp = created_at
    }

    index tag_index {
        type = plain
        source          = tag_src
        path            = /var/lib/manticore/tag_index

        docinfo         = extern
        mlock           = 0
        charset_table   = 0..9, A..Z->a..z, a..z
        min_word_len    = 1
        min_prefix_len  = 1
        prefix_fields   = text
        ngram_len       = 2
        ngram_chars     = U+AC00..U+D7AF, U+1100..U+11FF, U+3130..U+318F, U+3040..U+309F, U+30A0..U+30FF, U+4E00..U+9FFF
    }

    # ============================================
    # Autocomplete Index (User + Content + Tag 통합)
    # ============================================
    source autocomplete_src
    {
        type            = mysql
        sql_host        = ${MYSQL_HOST}
        sql_user        = ${DB_USERNAME}
        sql_pass        = ${DB_PASSWORD}
        sql_db          = ${MYSQL_DATABASE}
        sql_port        = ${MYSQL_PORT}
        sql_query       = \
            SELECT \
                (@rownum := @rownum + 1) AS id, \
                text, \
                type, \
                user_id, \
                usage_count \
            FROM ( \
                SELECT \
                    up.nickname AS text, \
                    'USER' AS type, \
                    u.id AS user_id, \
                    up.follower_count AS usage_count \
                FROM user_profiles up \
                INNER JOIN users u ON up.user_id = u.id \
                WHERE u.deleted_at IS NULL \
                  AND up.deleted_at IS NULL \
                  AND u.status = 'ACTIVE' \
                UNION ALL \
                SELECT \
                    cm.title AS text, \
                    'CONTENT' AS type, \
                    NULL AS user_id, \
                    ci.view_count AS usage_count \
                FROM content_metadata cm \
                INNER JOIN contents c ON cm.content_id = c.id \
                LEFT JOIN content_interactions ci ON c.id = ci.content_id \
                WHERE c.deleted_at IS NULL \
                  AND cm.deleted_at IS NULL \
                  AND c.status = 'PUBLISHED' \
                UNION ALL \
                SELECT \
                    t.name AS text, \
                    'TAG' AS type, \
                    NULL AS user_id, \
                    t.usage_count AS usage_count \
                FROM tags t \
                WHERE t.deleted_at IS NULL \
            ) AS combined, (SELECT @rownum := 0) AS r

        sql_attr_string = type
        sql_attr_string = user_id
        sql_attr_uint   = usage_count
    }

    index autocomplete_index {
        type = plain
        source          = autocomplete_src
        path            = /var/lib/manticore/autocomplete_index

        docinfo         = extern
        mlock           = 0
        charset_table   = 0..9, A..Z->a..z, a..z
        min_word_len    = 1
        min_prefix_len  = 1
        prefix_fields   = text
        ngram_len       = 2
        ngram_chars     = U+AC00..U+D7AF, U+1100..U+11FF, U+3130..U+318F, U+3040..U+309F, U+30A0..U+30FF, U+4E00..U+9FFF
    }
